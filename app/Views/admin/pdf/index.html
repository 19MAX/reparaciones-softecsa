<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pattern Lock</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #000;
    }
    .container {
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      width: 100%;
      max-width: 340px;
    }
    .lock {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      background: #fff;
      border: 2px solid #000;
      user-select: none;
      touch-action: none;
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .grid {
      position: relative;
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
    }
    .dot {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
    }
    .num {
      font-size: 18px;
      font-weight: 700;
      color: #666;
      transition: color 0.2s;
    }
    .circle {
      width: 12px;
      height: 12px;
      background: #000;
      border-radius: 50%;
      transition: all 0.2s;
    }
    .dot.active .circle {
      width: 24px;
      height: 24px;
    }
    .dot.active .num {
      color: #000;
    }
    .info {
      margin-top: 20px;
      padding: 15px;
      border: 2px solid #000;
      text-align: center;
    }
    .pattern {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 2px;
      min-height: 24px;
      color: #000;
    }
    .pattern.empty {
      color: #ccc;
    }
    .actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
    button {
      flex: 1;
      padding: 12px;
      font-size: 14px;
      font-weight: 600;
      border: 2px solid #000;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover {
      background: #000;
      color: #fff;
    }
    button:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="lock" id="lock">
      <canvas></canvas>
      <div class="grid"></div>
    </div>
    <div class="info">
      <div class="pattern empty">- - -</div>
    </div>
    <div class="actions">
      <button id="reset">Limpiar</button>
      <button id="get">Obtener</button>
    </div>
  </div>

  <script>
    class PatternLock {
      constructor(id) {
        this.lock = document.getElementById(id);
        this.canvas = this.lock.querySelector('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.grid = this.lock.querySelector('.grid');
        this.display = document.querySelector('.pattern');
        this.pattern = [];
        this.drawing = false;
        this.pos = {x: 0, y: 0};
        this.dots = [];
        this.centers = [];
        this.init();
      }

      init() {
        for (let i = 1; i <= 9; i++) {
          const dot = document.createElement('div');
          dot.className = 'dot';
          dot.dataset.num = i;
          dot.innerHTML = `<span class="num">${i}</span><div class="circle"></div>`;
          this.grid.appendChild(dot);
          this.dots.push(dot);
        }
        this.setupCanvas();
        this.calcCenters();
        this.events();
      }

      setupCanvas() {
        const rect = this.lock.getBoundingClientRect();
        this.canvas.width = rect.width;
        this.canvas.height = rect.height;
        this.calcCenters();
      }

      calcCenters() {
        const rect = this.lock.getBoundingClientRect();
        this.centers = [];
        this.dots.forEach(dot => {
          const circle = dot.querySelector('.circle');
          const r = circle.getBoundingClientRect();
          this.centers.push({
            num: +dot.dataset.num,
            x: r.left + r.width/2 - rect.left,
            y: r.top + r.height/2 - rect.top
          });
        });
      }

      events() {
        const getPos = e => {
          const rect = this.lock.getBoundingClientRect();
          const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
          const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
          return {x, y};
        };

        const start = e => {
          this.drawing = true;
          const pos = getPos(e);
          const num = this.findDot(pos.x, pos.y);
          if (num) this.add(num);
        };

        const move = e => {
          if (!this.drawing) return;
          e.preventDefault();
          this.pos = getPos(e);
          const num = this.findDot(this.pos.x, this.pos.y);
          if (num) this.add(num);
          this.draw();
        };

        const end = () => {
          this.drawing = false;
          this.draw();
        };

        this.lock.addEventListener('mousedown', start);
        this.lock.addEventListener('mousemove', move);
        document.addEventListener('mouseup', end);
        this.lock.addEventListener('touchstart', start, {passive: false});
        this.lock.addEventListener('touchmove', move, {passive: false});
        document.addEventListener('touchend', end);
      }

      findDot(x, y) {
        for (let d of this.centers) {
          const dist = Math.sqrt((x - d.x)**2 + (y - d.y)**2);
          if (dist < 35) return d.num;
        }
        return null;
      }

      add(num) {
        if (this.pattern.includes(num)) return;
        this.pattern.push(num);
        this.dots.find(d => +d.dataset.num === num).classList.add('active');
        this.updateDisplay();
      }

      draw() {
        const w = this.canvas.width, h = this.canvas.height;
        this.ctx.clearRect(0, 0, w, h);
        if (this.pattern.length === 0) return;

        this.ctx.strokeStyle = '#000';
        this.ctx.lineWidth = 3;
        this.ctx.lineCap = 'round';
        this.ctx.beginPath();

        const first = this.centers.find(d => d.num === this.pattern[0]);
        this.ctx.moveTo(first.x, first.y);

        for (let i = 1; i < this.pattern.length; i++) {
          const d = this.centers.find(c => c.num === this.pattern[i]);
          this.ctx.lineTo(d.x, d.y);
        }

        if (this.drawing) this.ctx.lineTo(this.pos.x, this.pos.y);
        this.ctx.stroke();

        this.pattern.forEach(num => {
          const d = this.centers.find(c => c.num === num);
          this.ctx.beginPath();
          this.ctx.arc(d.x, d.y, 5, 0, Math.PI * 2);
          this.ctx.fillStyle = '#000';
          this.ctx.fill();
        });
      }

      updateDisplay() {
        if (this.pattern.length > 0) {
          this.display.textContent = this.pattern.join(' - ');
          this.display.classList.remove('empty');
        } else {
          this.display.textContent = '- - -';
          this.display.classList.add('empty');
        }
      }

      getPattern() {
        return this.pattern.length >= 4 
          ? {success: true, pattern: this.pattern.join(''), array: [...this.pattern]}
          : {success: false, message: 'Mínimo 4 puntos'};
      }

      reset() {
        this.pattern = [];
        this.drawing = false;
        this.dots.forEach(d => d.classList.remove('active'));
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.updateDisplay();
      }
    }

    const lock = new PatternLock('lock');
    
    // Función pública para obtener el patrón
    window.getPattern = () => lock.getPattern();

    document.getElementById('reset').onclick = () => lock.reset();
    document.getElementById('get').onclick = () => {
      const result = lock.getPattern();
      alert(result.success ? `Patrón: ${result.pattern}` : result.message);
      console.log(result);
    };
  </script>
</body>
</html>